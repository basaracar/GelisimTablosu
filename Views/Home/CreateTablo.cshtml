@using System.Text.Json
@{
    ViewData["Title"] = "Tablo Oluştur";
    string[] dalim = { "Yazılım Geliştirme", "Ağ İşletmenliği" };
    int d = ViewBag.Dal != null ? (int)ViewBag.Dal : 0;
}

<div id="tablo-container"></div>
<script>
    // Razor ile JSON'u güvenli şekilde serialize ediyoruz
    var tamListe = JSON.parse('@Html.Raw(JsonSerializer.Serialize(ViewBag.tamListe ?? null))');
    if(tamListe==null || tamListe.length === 0) {
        document.getElementById('tablo-container').innerHTML = '<div class="alert alert-danger">Veri bulunamadı.</div>';
    }
    // Dal isimlerini enum'dan alıyoruz
    var dalim = ["Yazılım Geliştirme", "Ağ İşletmenliği"];
    var d = @d;
    var sayac = 1;
    function createTabloHtml(tablo) {
        // tablo: { Student: {...}, Konular: [...] }
        var html = '';
        html += '<div style="page-break-after: always;" class="print-content">';
        html += '<h5 class="text-center"><strong>ŞEHİT UZMAN ÇAVUŞ HARUN ŞENÖZÜAR MESLEKİ VE TEKNİK ANADOLU LİSESİ</strong></h5>';
        html += '<h5 class="text-center"><strong>İŞLETMELERDE MESLEK EĞİTİMİNE DEVAM EDEN ÖĞRENCİLERE AİT GELİŞİM TABLOSU</strong></h5>';
        html += '<div class="row  justify-content-end"><div class="col-2 ms-auto"><strong>İME-GELİŞİM</strong></div></div>';
        html += '<div class="row"><div class="col"><strong>İşletmenin Adı :' + (tablo.Student?.Isletme ?? "") + '</strong></div>';
        html += '<div class="col"><strong>Meslek Alan/Dalı : Bilişim Teknolojileri / ' + dalim[d] + '</strong></div></div>';
        html += '<div class="row"><div class="col"><strong>Öğrencinin Adı: ' + (tablo.Student?.Ad ?? "") + '</strong></div>';
        html += '<div class="col"><strong>Sınıfı : ' + (tablo.Student?.Sinif ?? "") + '</strong></div></div>';
        html += '<table class="table table-bordered"><thead><tr><th>Kategori</th><th>Konu Başlığı</th><th>Yapıldı</th></tr></thead><tbody>';
        // Konular: kategori bazında
        if (Array.isArray(tablo.Konular)) {
            tablo.Konular.forEach(function(kategoriKonular) {
                if (Array.isArray(kategoriKonular)) {
                    kategoriKonular.forEach(function(konu) {
                        html += '<tr>';
                        html += '<td>' + sayac + '</td>';
                        html += '<td>' + (konu.Baslik ?? "") + '</td>';
                        html += '<td></td>';
                        html += '</tr>';
                        sayac++;
                    });
                } else if (kategoriKonular && typeof kategoriKonular === 'object') {
                    html += '<tr>';
                    html += '<td>' + sayac + '</td>';
                    html += '<td>' + (kategoriKonular.Baslik ?? "") + '</td>';
                    html += '<td></td>';
                    html += '</tr>';
                    sayac++;
                }
            });
        }
        html += '</tbody></table>';
        html += '<div class="row"><div class="col-12"><strong>AÇIKLAMA: </strong></div>';
        html += '<div class="col-12"><ol>';
        html += '<li>Bu gelişim tablosu, zümre öğretmenlerince öğretim programları esas alınarak her meslek alanı için ayrı hazırlanacak ve uygulamaya konulacaktır.</li>';
        html += '<li>Gelişim tablosu, işletmelerde öğretim programlarına uygun eğitim yapılıp yapılmadığını ve öğrencilerin telâfi eğitimine ihtiyaç duyulup duyulmadığının tespiti amacıyla kullanılacaktır.</li>';
        html += '</ol></div></div>';
        html += '<div class="row  g-2"><div class="col"><br /><br /><br /><strong>İşletme İmza</strong></div><div class="col"></div></div>';
        html += '</div>';
        return html;
    }

    if (tamListe && Array.isArray(tamListe)) {
        var container = document.getElementById('tablo-container');
        tamListe.forEach(function(tablo) {
            container.innerHTML += createTabloHtml(tablo);
        });
    } else {
        document.getElementById('tablo-container').innerHTML = '<div class="alert alert-danger">Tablo verisi bulunamadı.</div>';
    }
</script>